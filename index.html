<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å­—æ¯æ‹¼å­—éŠæˆ² - é»é¸èˆ‡ç™¼éŸ³</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* å­—æ¯æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .letter-button {
            /* è®“æŒ‰éˆ•åœ¨å°è¢å¹•ä¸Šä¹Ÿèƒ½ä¿æŒè‰¯å¥½é–“è·å’Œå¤§å° */
            min-width: 50px; 
            min-height: 50px;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="w-full max-w-lg bg-white p-8 rounded-2xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">è‹±æ–‡å­—æ¯æ‹¼å­—æŒ‘æˆ° (é»é¸æ¨¡å¼)</h1>
        <p class="text-center text-gray-500 mb-6">é»é¸ä¸‹æ–¹å­—æ¯æŒ‰éˆ•ï¼Œå°‡å®ƒå€‘é‡æ–°æ’åˆ—æˆæ­£ç¢ºçš„æ•¸å­—å–®å­— (1-5)ã€‚</p>

        <!-- é‡‘å¹£èˆ‡é€²åº¦é¡¯ç¤º -->
        <div class="flex justify-between items-center mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-yellow-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2M21 12a9 9 0 11-18 0 9 9 0 0118 0zM17 14v2m0 0v2m0-2h2m-2 0h-2M7 14v2m0 0v2m0-2h2m-2 0h-2"></path></svg>
                <span class="text-lg font-semibold text-gray-700">é‡‘å¹£: <span id="coin-display">0</span></span>
            </div>
            <span class="text-sm font-medium text-gray-600">é€²åº¦: <span id="progress-display">0/5</span></span>
        </div>

        <!-- ç­”æ¡ˆé¡¯ç¤ºå€ -->
        <div class="mb-4">
            <div id="answer-area" 
                 class="w-full h-16 flex items-center justify-center p-3 border-2 border-green-400 bg-green-50 rounded-lg text-3xl font-bold tracking-widest text-green-700 uppercase transition duration-200 shadow-inner">
                <!-- ä½¿ç”¨è€…é»é¸çš„ç­”æ¡ˆæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
        
        <!-- æ¸…é™¤æŒ‰éˆ• -->
        <!-- æ¸…é™¤æŒ‰éˆ•åœ¨æ–°çš„æµç¨‹ä¸­ä¸å†å¿…è¦ï¼Œå› ç‚ºåªæœ‰ä¸€æ¬¡æ©Ÿæœƒï¼Œä½†ä¿ç•™åŠŸèƒ½ -->
        <button id="clear-button" 
                class="w-full py-2 mb-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-200">
            æ¸…é™¤ç­”æ¡ˆ
        </button>

        <!-- å­—æ¯æŒ‰éˆ•å€èˆ‡ç™¼éŸ³æŒ‰éˆ• -->
        <div class="flex flex-col items-center mb-8">
            <!-- ç™¼éŸ³æŒ‰éˆ• -->
            <button id="speaker-icon" 
                    class="p-3 mb-4 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-110 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" 
                    aria-label="æ’­æ”¾å–®å­—ç™¼éŸ³">
                <!-- Speaker Icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.899a9 9 0 010 12.728M5.586 15H3a2 2 0 01-2-2V9a2 2 0 012-2h2.586l4.586-4.586A2 2 0 0113 4v16a2 2 0 01-3.828.914L5.586 15z"></path></svg>
            </button>
            
            <!-- å­—æ¯æŒ‰éˆ•å®¹å™¨ -->
            <div id="scrambled-word" class="flex justify-center flex-wrap gap-3">
                <!-- éš¨æ©Ÿå­—æ¯æŒ‰éˆ•æœƒç”± JS æ’å…¥æ­¤è™• -->
            </div>
        </div>


        <!-- è¨Šæ¯/çµæœé¡¯ç¤ºå€ -->
        <div id="message" class="mt-6 text-center text-lg font-medium min-h-[1.75rem]">
            <!-- éŠæˆ²è¨Šæ¯æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
        
        <!-- æ˜µç¨±è¼¸å…¥å€ (éŠæˆ²çµæŸæ™‚é¡¯ç¤º) -->
        <div id="nickname-input-area" class="hidden flex flex-col items-center mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <label for="nickname-input" class="text-lg font-semibold text-blue-800 mb-2">æ‚¨æƒ³ç”¨ä»€éº¼åå­—ä¸Šæ¦œï¼Ÿ</label>
            <input type="text" id="nickname-input" placeholder="è¼¸å…¥æ‚¨çš„æ˜µç¨±..." maxlength="20"
                   class="w-full p-2 border border-blue-400 rounded-lg text-center mb-3 focus:ring-2 focus:ring-blue-500">
            <button id="submit-score-button"
                    class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                æäº¤åˆ†æ•¸
            </button>
        </div>

        <!-- é‡æ–°é–‹å§‹æŒ‰éˆ• (æäº¤æ˜µç¨±å¾Œæˆ–åˆ†æ•¸æäº¤å¤±æ•—æ™‚é¡¯ç¤º) -->
        <button id="restart-button"
                class="hidden w-full py-3 mt-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200">
            é‡æ–°é–‹å§‹éŠæˆ²
        </button>

        <!-- æ’è¡Œæ¦œå€ -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <h2 class="text-xl font-bold text-center text-gray-700 mb-4">ğŸ‘‘ å…¨çƒæ’è¡Œæ¦œ (Top 5)</h2>
            <div id="leaderboard-list" class="space-y-2">
                <!-- æ’è¡Œæ¦œé …ç›®æœƒç”± JS æ’å…¥æ­¤è™• -->
                <p class="text-center text-gray-400" id="leaderboard-loading">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

    </div>

    <!-- Firebase å’Œ TTS è…³æœ¬ -->
    <script type="module">
        // Firebase æ¨¡çµ„å°å…¥ (å·²æ›´æ–°ç‚º 12.6.0 ç‰ˆæœ¬)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel, collection, addDoc, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- ä½¿ç”¨è€…æä¾›çš„å€‹äºº Firebase é…ç½® ---
        const appId = "englearn-e6a99"; // ä½¿ç”¨æ‚¨çš„ Project ID ä½œç‚º App ID
        const firebaseConfig = {
            apiKey: "AIzaSyDjJIccIT082nCnC0fymHPYJyOV31TiOvE",
            authDomain: "englearn-e6a99.firebaseapp.com",
            projectId: "englearn-e6a99",
            storageBucket: "englearn-e6a99.firebasestorage.app",
            messagingSenderId: "578532575718",
            appId: "1:578532575718:web:ff92202c756c235b6cee27",
            measurementId: "G-6WF7TG5KF3"
        };

        // éŠæˆ²æ ¸å¿ƒæ•¸æ“š
        const WORDS = ["ONE", "TWO", "THREE", "FOUR", "FIVE"];
        const WIN_COINS = 100;

        let db;
        let auth;
        let userId = null; // ä»ç”¨æ–¼ç§äººå­˜æª”
        let finalScore = 0; // éŠæˆ²çµæŸæ™‚çš„æœ€çµ‚åˆ†æ•¸
        let currentCoins = 0;
        let wordIndex = 0;
        let gameActive = false;
        let unsubscribePrivate = null; 
        let unsubscribePublic = null; 

        // DOM å…ƒç´ 
        const coinDisplay = document.getElementById('coin-display');
        const progressDisplay = document.getElementById('progress-display');
        const scrambledWordEl = document.getElementById('scrambled-word');
        const answerArea = document.getElementById('answer-area'); 
        const messageEl = document.getElementById('message');
        const restartButton = document.getElementById('restart-button');
        const clearButton = document.getElementById('clear-button'); 
        const speakerIcon = document.getElementById('speaker-icon'); 
        const leaderboardList = document.getElementById('leaderboard-list'); 
        const nicknameInputArea = document.getElementById('nickname-input-area'); 
        const nicknameInput = document.getElementById('nickname-input'); 
        const submitScoreButton = document.getElementById('submit-score-button'); 

        // --- éŸ³é »è™•ç†è¼”åŠ©å‡½æ•¸ (TTS API è¿”å› PCM æ•¸æ“šï¼Œéœ€è¦è½‰æ›ç‚º WAV) ---

        /**
         * å°‡ Base64 å­—ä¸²è½‰æ›ç‚º ArrayBufferã€‚
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * å¯«å…¥å­—ä¸²åˆ° DataView (ç”¨æ–¼ WAV æ¨™é ­)ã€‚
         */
        function writeString(view, offset, str) {
            for (let i = 0; i < str.length; i++) {
                view.setUint8(offset + i, str.charCodeAt(i));
            }
        }

        /**
         * å°‡ PCM æ•¸æ“šè½‰æ›ç‚º WAV Blobã€‚
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitDepth = 16;
            const byteRate = sampleRate * numChannels * (bitDepth / 8);
            const blockAlign = numChannels * (bitDepth / 8);
            
            const pcmDataLength = pcm16.byteLength;
            const wavFileLength = 44 + pcmDataLength; // 44 bytes for header

            const buffer = new ArrayBuffer(wavFileLength);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF'); 
            view.setUint32(4, wavFileLength - 8, true); 
            writeString(view, 8, 'WAVE'); 

            // FMT sub-chunk
            writeString(view, 12, 'fmt '); 
            view.setUint32(16, 16, true); 
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); 
            view.setUint32(24, sampleRate, true); 
            view.setUint32(28, byteRate, true); 
            view.setUint16(32, blockAlign, true); 
            view.setUint16(34, bitDepth, true); 

            // DATA sub-chunk
            writeString(view, 36, 'data'); 
            view.setUint32(40, pcmDataLength, true); 

            // Write PCM data
            const pcmDataView = new DataView(pcm16.buffer);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcmDataView.getInt16(i * 2, true), true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- è¼”åŠ©å‡½æ•¸ ---

        /**
         * éš¨æ©Ÿæ‰“äº‚å­—ä¸²ä¸­çš„å­—æ¯ã€‚
         */
        function scrambleWord(str) {
            const arr = str.split('');
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr.join('');
        }

        /**
         * é¡¯ç¤ºè¨Šæ¯ä¸¦åœ¨çŸ­æš«å»¶é²å¾Œæ¸…é™¤ã€‚
         */
        function displayMessage(msg, color) {
            messageEl.textContent = msg;
            messageEl.className = `mt-6 text-center text-lg font-medium ${color}`;
            setTimeout(() => {
                // å¦‚æœéŠæˆ²é‚„åœ¨é€²è¡Œä¸­ï¼Œæ‰æ¸…é™¤è‡¨æ™‚è¨Šæ¯
                if (gameActive) {
                    messageEl.textContent = 'è«‹é»é¸å­—æ¯æ‹¼å‡ºå–®å­—ã€‚';
                    messageEl.className = `mt-6 text-center text-lg font-medium text-gray-500`;
                }
            }, 2500);
        }
        
        // --- Firebase/Firestore é‚è¼¯ ---
        
        function initializeFirebase() {
            try {
                setLogLevel('Debug');
                // ä½¿ç”¨ç”¨æˆ¶æä¾›çš„ firebaseConfig é€²è¡Œåˆå§‹åŒ–
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthStateListener();
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                displayMessage('åˆå§‹åŒ–éŒ¯èª¤: ç„¡æ³•é€£æ¥è³‡æ–™åº«ã€‚', 'text-red-600');
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    loadUserData(userId);
                } else {
                    authenticateUser();
                }
            });
        }

        async function authenticateUser() {
            try {
                // ç”±æ–¼æ˜¯å€‹äººå°ˆæ¡ˆï¼Œç›´æ¥ä½¿ç”¨åŒ¿åç™»å…¥
                await signInAnonymously(auth);
            } catch (error) {
                // å¦‚æœèªè­‰å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ ID ä½œç‚ºåŒ¿åç”¨æˆ¶
                console.error("Firebase åŒ¿åç™»å…¥å¤±æ•—:", error);
                userId = crypto.randomUUID(); 
                loadUserData(userId);
            }
        }

        function loadUserData(currentUserId) {
            // ç§äººæ•¸æ“šè·¯å¾‘ï¼šç”¨æ–¼å­˜å„²ç”¨æˆ¶çš„ç§äººé‡‘å¹£/é€²åº¦
            // è·¯å¾‘: artifacts/{appId}/users/{userId}/spelling_game_data/stats
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/spelling_game_data/stats`);

            if (unsubscribePrivate) {
                unsubscribePrivate(); 
            }

            // ç›£è½ç§äººé‡‘å¹£æ•¸æ“š
            unsubscribePrivate = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentCoins = docSnap.data().coins || 0;
                } else {
                    currentCoins = 0;
                    saveCoins(currentCoins); // åˆå§‹åŒ–ç§äººç´€éŒ„
                }
                coinDisplay.textContent = currentCoins;
                // åªæœ‰åœ¨éŠæˆ²æœªå•Ÿå‹•æ™‚æ‰å•Ÿå‹•éŠæˆ²
                if (!gameActive) {
                    startGame();
                    loadLeaderboard(); // ç§äººæ•¸æ“šè¼‰å…¥å®Œæˆå¾Œé–‹å§‹è¼‰å…¥æ’è¡Œæ¦œ
                }
            }, (error) => {
                console.error("Firestore ç§äººç›£è½å¤±æ•—:", error);
                // ç”±æ–¼è¦å‰‡éŒ¯èª¤æ‡‰è©²å·²è§£æ±ºï¼Œå¦‚æœä»æœ‰éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å…¶ä»–å•é¡Œï¼Œä½†æˆ‘å€‘ä»å˜—è©¦å•Ÿå‹•éŠæˆ²
                if (!gameActive) {
                    startGame();
                    loadLeaderboard();
                }
            });
        }

        async function saveCoins(coins) {
            if (!userId) return; 

            // ç§äººæ•¸æ“šå„²å­˜
            const privateDocRef = doc(db, `artifacts/${appId}/users/${userId}/spelling_game_data/stats`);
            try {
                await setDoc(privateDocRef, { coins: coins }, { merge: true });
            } catch (error) {
                console.error("å„²å­˜ç§äººé‡‘å¹£å¤±æ•—:", error);
            }
        }
        
        /**
         * å°‡æœ€çµ‚åˆ†æ•¸èˆ‡æ˜µç¨±å„²å­˜åˆ°å…¬é–‹æ’è¡Œæ¦œã€‚
         */
        async function submitHighScore(nickname, score) {
            if (!nickname || score <= 0) {
                // å¦‚æœåˆ†æ•¸ç‚º 0 æˆ–æ²’æœ‰æ˜µç¨±ï¼Œç›´æ¥é¡¯ç¤ºé‡æ–°é–‹å§‹
                 nicknameInputArea.classList.add('hidden');
                 restartButton.classList.remove('hidden');
                 displayMessage('åˆ†æ•¸éœ€å¤§æ–¼é›¶æ‰èƒ½ä¸Šæ¦œã€‚', 'text-orange-600');
                 return;
            }
            submitScoreButton.disabled = true;

            // å…¬é–‹æ•¸æ“šè·¯å¾‘: /artifacts/{appId}/public/data/leaderboard_scores
            const collectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard_scores`);

            try {
                // ä½¿ç”¨ addDoc å‰µå»ºæ–°æ–‡ä»¶ï¼Œè®“æ¯å€‹æ˜µç¨±éƒ½èƒ½è¨˜éŒ„ä¸€ç­†åˆ†æ•¸
                await addDoc(collectionRef, { 
                    nickname: nickname.substring(0, 20), // é™åˆ¶æ˜µç¨±é•·åº¦
                    coins: score, 
                    originalUserId: userId, // ä¿ç•™åŸ ID ä»¥ä¾›è¿½è¹¤
                    timestamp: serverTimestamp() // è¨˜éŒ„æäº¤æ™‚é–“
                });
                displayMessage(`æ­å–œ ${nickname}ï¼æ‚¨çš„åˆ†æ•¸ ${score} å·²æˆåŠŸè¨˜éŒ„åˆ°æ’è¡Œæ¦œï¼`, 'text-purple-600');
            } catch (error) {
                console.error("æäº¤æ’è¡Œæ¦œåˆ†æ•¸å¤±æ•—:", error);
                displayMessage('æ’è¡Œæ¦œæäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'text-red-600');
            } finally {
                // ä¸è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½é¡¯ç¤ºé‡æ–°é–‹å§‹æŒ‰éˆ•ä¸¦éš±è—è¼¸å…¥å€
                nicknameInputArea.classList.add('hidden');
                restartButton.classList.remove('hidden');
            }
        }
        
        /**
         * å¾ Firestore è¼‰å…¥ä¸¦é¡¯ç¤ºæ’è¡Œæ¦œã€‚
         */
        function loadLeaderboard() {
            // å…¬é–‹æ•¸æ“šé›†åˆè·¯å¾‘: /artifacts/{appId}/public/data/leaderboard_scores
            const collectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard_scores`);
            
            if (unsubscribePublic) {
                unsubscribePublic();
            }

            // ç›£è½æ’è¡Œæ¦œæ•¸æ“š (ç²å–æ‰€æœ‰æ•¸æ“šåœ¨æœ¬åœ°æ’åº)
            unsubscribePublic = onSnapshot(collectionRef, (snapshot) => {
                const scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.coins && data.nickname) {
                        scores.push({
                            id: doc.id,
                            nickname: data.nickname,
                            coins: data.coins,
                            originalUserId: data.originalUserId 
                        });
                    }
                });

                // 1. æœ¬åœ°æ’åºï¼šåˆ†æ•¸é™åº
                scores.sort((a, b) => b.coins - a.coins);
                
                // 2. é¡¯ç¤ºå‰ 5 å
                renderLeaderboard(scores.slice(0, 5));

            }, (error) => {
                console.error("æ’è¡Œæ¦œç›£è½å¤±æ•—:", error);
                leaderboardList.innerHTML = '<p class="text-center text-red-500">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—ã€‚</p>';
            });
        }
        
        /**
         * æ¸²æŸ“æ’è¡Œæ¦œåˆ° UIã€‚
         * @param {Array<{id: string, nickname: string, coins: number, originalUserId: string}>} scores - æ’è¡Œæ¦œæ•¸æ“šã€‚
         */
        function renderLeaderboard(scores) {
            leaderboardList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

            if (scores.length === 0) {
                leaderboardList.innerHTML = '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰åˆ†æ•¸ç´€éŒ„ã€‚</p>';
                return;
            }

            scores.forEach((score, index) => {
                const rank = index + 1;
                let colorClass = 'text-gray-700';
                let icon = '';

                if (rank === 1) {
                    colorClass = 'text-yellow-600 font-extrabold bg-yellow-100';
                    icon = 'ğŸ¥‡';
                } else if (rank === 2) {
                    colorClass = 'text-gray-600 font-bold bg-gray-100';
                    icon = 'ğŸ¥ˆ';
                } else if (rank === 3) {
                    colorClass = 'text-amber-600 font-bold bg-amber-100';
                    icon = 'ğŸ¥‰';
                }

                const item = document.createElement('div');
                // ä½¿ç”¨ originalUserId åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å‰ç”¨æˆ¶
                const isCurrentUser = score.originalUserId === userId; 
                item.className = `flex justify-between items-center p-3 rounded-lg shadow-sm transition duration-150 ${colorClass} ${isCurrentUser ? 'border-2 border-blue-500 bg-blue-50 font-bold' : ''}`;
                
                const displayNickname = score.nickname + (isCurrentUser ? ' (æ‚¨)' : '');

                item.innerHTML = `
                    <span class="flex items-center space-x-2">
                        <span class="text-xl w-6 text-center">${icon || rank}</span>
                        <span class="truncate text-sm md:text-base">${displayNickname}</span>
                    </span>
                    <span class="text-lg font-semibold">${score.coins} é‡‘å¹£</span>
                `;
                leaderboardList.appendChild(item);
            });
        }


        // --- TTS ç™¼éŸ³é‚è¼¯ (ç„¡è®Šå‹•) ---

        /**
         * å–å¾—ä¸¦æ’­æ”¾ç•¶å‰å–®å­—çš„ç™¼éŸ³ã€‚
         * @param {string} word - è¦ç™¼éŸ³çš„å–®å­—ã€‚
         */
        async function fetchAndPlayPronunciation(word) {
            if (!speakerIcon) return;

            speakerIcon.disabled = true;
            speakerIcon.classList.add('animate-pulse'); // é¡¯ç¤ºè¼‰å…¥ä¸­æ•ˆæœ

            const ttsModel = "gemini-2.5-flash-preview-tts";
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${ttsModel}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: `Say clearly: ${word}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                },
            };

            let response, result;
            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) { 
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error(`TTS API éŒ¯èª¤: ${response.status}`);
                    }

                    result = await response.json();
                    break; 

                } catch (error) {
                    console.error("TTS API å‘¼å«å¤±æ•—:", error);
                    displayMessage('ç™¼éŸ³è¼‰å…¥å¤±æ•—ã€‚', 'text-red-500');
                    speakerIcon.disabled = false;
                    speakerIcon.classList.remove('animate-pulse');
                    return;
                }
            }

            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; 
                
                try {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play().catch(e => console.error("éŸ³é »æ’­æ”¾å¤±æ•—:", e));

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        speakerIcon.disabled = false;
                        speakerIcon.classList.remove('animate-pulse');
                    };

                } catch (e) {
                    console.error("éŸ³é »è½‰æ›æˆ–æ’­æ”¾å¤±æ•—:", e);
                    displayMessage('éŸ³é »è™•ç†å¤±æ•—ã€‚', 'text-red-500');
                    speakerIcon.disabled = false;
                    speakerIcon.classList.remove('animate-pulse');
                }
            } else {
                console.error("TTS éŸ¿æ‡‰ç„¡æ•ˆæˆ–ç¼ºå°‘éŸ³é »æ•¸æ“š:", result);
                displayMessage('ç™¼éŸ³æ•¸æ“šç„¡æ•ˆã€‚', 'text-red-500');
                speakerIcon.disabled = false;
                speakerIcon.classList.remove('animate-pulse');
            }
        }


        // --- éŠæˆ²é‚è¼¯ ---

        /**
         * è™•ç†å­—æ¯æŒ‰éˆ•é»æ“Šäº‹ä»¶ã€‚
         */
        function handleLetterClick(event) {
            if (!gameActive) return;

            const button = event.target;
            const letter = button.textContent;

            // 1. å°‡å­—æ¯æ·»åŠ åˆ°ç­”æ¡ˆå€
            answerArea.textContent += letter;

            // 2. ç¦ç”¨è¢«é»æ“Šçš„æŒ‰éˆ•
            button.disabled = true;

            // 3. æª¢æŸ¥ç­”æ¡ˆé•·åº¦ï¼Œå¦‚æœæ»¿äº†å°±è‡ªå‹•æäº¤ (ç¾åœ¨æ˜¯è‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ)
            const currentWord = WORDS[wordIndex];
            if (answerArea.textContent.length === currentWord.length) {
                checkAnswer();
            }
        }

        /**
         * æ¸…é™¤ç­”æ¡ˆå€ä¸¦é‡æ–°å•Ÿç”¨æ‰€æœ‰å­—æ¯æŒ‰éˆ•ã€‚
         */
        function clearAnswer() {
            if (!gameActive) return;

            answerArea.textContent = '';
            // é‡æ–°å•Ÿç”¨æ‰€æœ‰å­—æ¯æŒ‰éˆ•
            scrambledWordEl.querySelectorAll('button').forEach(button => {
                button.disabled = false;
            });
            // æ¸…é™¤è¨Šæ¯
            displayMessage('è«‹é»é¸å­—æ¯æ‹¼å‡ºå–®å­—ã€‚', 'text-gray-500');
        }


        /**
         * é–‹å§‹éŠæˆ²ã€‚
         */
        function startGame() {
            wordIndex = 0;
            // é‡ç½®é‡‘å¹£ï¼Œå› ç‚ºé€™æ˜¯ä¸€å€‹æ–°çš„æŒ‘æˆ°
            currentCoins = 0; 
            coinDisplay.textContent = currentCoins;
            saveCoins(currentCoins); // æ¸…ç©ºç§äººå­˜æª”çš„åˆ†æ•¸

            gameActive = true;
            finalScore = 0;
            restartButton.classList.add('hidden');
            nicknameInputArea.classList.add('hidden'); 
            clearButton.classList.remove('hidden');
            speakerIcon.classList.remove('hidden');
            answerArea.textContent = '';
            loadWord();
        }

        /**
         * è¼‰å…¥ç•¶å‰ç´¢å¼•çš„å–®å­—ã€‚
         */
        function loadWord() {
            if (wordIndex >= WORDS.length) {
                endGame();
                return;
            }

            const currentWord = WORDS[wordIndex];
            // ç¢ºä¿æ‰“äº‚å¾Œçš„å­—ä¸²èˆ‡åŸå­—ä¸²ä¸åŒ
            let scrambled = scrambleWord(currentWord);
            while (scrambled === currentWord) {
                scrambled = scrambleWord(currentWord);
            }

            scrambledWordEl.innerHTML = ''; // æ¸…é™¤èˆŠæŒ‰éˆ•
            answerArea.textContent = ''; // æ¸…é™¤ç­”æ¡ˆå€
            speakerIcon.disabled = false;

            // å‰µå»ºå­—æ¯æŒ‰éˆ•
            scrambled.split('').forEach((letter, index) => {
                const button = document.createElement('button');
                button.textContent = letter;
                button.dataset.originalIndex = index; 
                // Tailwind class for button styling
                button.className = 'letter-button bg-blue-500 text-white p-3 rounded-lg font-bold uppercase transition duration-150 transform hover:scale-105 active:bg-blue-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none';
                button.addEventListener('click', handleLetterClick);
                scrambledWordEl.appendChild(button);
            });
            
            // ç¶å®šç™¼éŸ³äº‹ä»¶
            speakerIcon.onclick = () => fetchAndPlayPronunciation(currentWord);

            progressDisplay.textContent = `${wordIndex + 1}/${WORDS.length}`;
            displayMessage('è«‹é»é¸å­—æ¯æ‹¼å‡ºå–®å­—ã€‚', 'text-gray-500');
        }

        /**
         * æª¢æŸ¥ä½¿ç”¨è€…çš„ç­”æ¡ˆä¸¦é€²å…¥ä¸‹ä¸€é¡Œã€‚
         */
        async function checkAnswer() {
            if (!gameActive) return;

            const currentWord = WORDS[wordIndex];
            const answer = answerArea.textContent.trim().toUpperCase();

            // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•å’Œæ¸…é™¤/ç™¼éŸ³ï¼Œé˜²æ­¢å¤šæ¬¡æäº¤
            scrambledWordEl.querySelectorAll('button').forEach(btn => btn.disabled = true);
            clearButton.disabled = true;
            speakerIcon.disabled = true;


            if (answer === currentWord) {
                // ç­”å°äº†ï¼šç´¯ç©é‡‘å¹£
                currentCoins += WIN_COINS;
                coinDisplay.textContent = currentCoins;
                await saveCoins(currentCoins); // å„²å­˜ç§äººé‡‘å¹£ç´€éŒ„

                displayMessage(`âœ… æ­£ç¢ºï¼æ‚¨ç²å¾—äº† ${WIN_COINS} é‡‘å¹£ï¼`, 'text-green-600');
            } else {
                // ç­”éŒ¯äº†ï¼šé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
                displayMessage(`âŒ éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentWord}ã€‚`, 'text-red-600');
            }

            // ç„¡è«–å°éŒ¯ï¼Œéƒ½é€²å…¥ä¸‹ä¸€é¡Œ (æˆ–çµæŸéŠæˆ²)
            wordIndex++;
            setTimeout(() => {
                clearButton.disabled = false;
                loadWord(); // è¼‰å…¥ä¸‹ä¸€å€‹å–®å­—æˆ–è§¸ç™¼ endGame()
            }, 1000);
        }

        /**
         * çµæŸéŠæˆ²ï¼Œé¡¯ç¤ºæœ€çµ‚åˆ†æ•¸ï¼Œä¸¦æç¤ºè¼¸å…¥æ˜µç¨±ã€‚
         */
        function endGame() {
            gameActive = false;
            finalScore = currentCoins; // è¨˜éŒ„æœ€çµ‚åˆ†æ•¸
            
            scrambledWordEl.innerHTML = '<span class="text-xl text-gray-600">æŒ‘æˆ°å®Œæˆï¼</span>';
            progressDisplay.textContent = `${WORDS.length}/${WORDS.length}`;
            answerArea.textContent = 'çµæŸ';
            clearButton.classList.add('hidden');
            speakerIcon.classList.add('hidden');
            
            displayMessage(`æ­å–œï¼æŒ‘æˆ°å®Œæˆï¼æ‚¨çš„æœ€çµ‚åˆ†æ•¸æ˜¯ ${finalScore} é‡‘å¹£ã€‚`, 'text-blue-700 font-extrabold');

            // é¡¯ç¤ºæ˜µç¨±è¼¸å…¥å€
            nicknameInputArea.classList.remove('hidden');
            nicknameInput.value = ''; // æ¸…ç©ºä¸Šæ¬¡çš„è¼¸å…¥
            submitScoreButton.disabled = false;
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---

        // è™•ç†æ¸…é™¤æŒ‰éˆ•
        clearButton.addEventListener('click', clearAnswer);

        // è™•ç†é‡æ–°é–‹å§‹æŒ‰éˆ•
        restartButton.addEventListener('click', startGame);

        // è™•ç†æäº¤åˆ†æ•¸æŒ‰éˆ•
        submitScoreButton.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            if (nickname.length > 0) {
                submitHighScore(nickname, finalScore);
            } else {
                displayMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ˜µç¨±ï¼', 'text-orange-600');
            }
        });

        // åˆå§‹åŒ– Firebase
        initializeFirebase();

    </script>
</body>
</html>